#!/usr/bin/env bash
set -Eeuo pipefail
trap 'echo "ERROR on line $LINENO. Exiting." >&2' ERR

### ───────────────────────────
### EDIT THESE FOR YOUR SETUP
### ───────────────────────────
# If you configured a VirtualBox Shared Folder, set its NAME here (VirtualBox UI → Settings → Shared Folders)
VB_SHARE_NAME="${VB_SHARE_NAME:-lab}"      # name seen in VBox, e.g., "lab"
LAB_MOUNT="${LAB_MOUNT:-$HOME/lab}"        # where to mount inside the VM

# If you prefer git instead of a shared folder, set REPO_URL (used only if share can’t be mounted)
REPO_URL="${REPO_URL:-https://github.com/montybeatnik/arista-lab.git}"
REPO_BRANCH="${REPO_BRANCH:-main}"

# Optional: cEOS tarball path *inside this VM* (leave empty to skip)
CEOS_TARBALL="${CEOS_TARBALL:-}"
CEOS_TAG="${CEOS_TAG:-ceosimage:4.34.2.1f}"

# Lab file path relative to repo root
LAB_FILE="${LAB_FILE:-lab.clab.yml}"

# Auto deploy after setup? (1=yes, 0=no)
AUTO_DEPLOY="${AUTO_DEPLOY:-1}"

### ───────────────────────────
### helpers
### ───────────────────────────
err()  { echo "ERROR: $*" >&2; exit 1; }
need() { command -v "$1" >/dev/null 2>&1 || err "Missing dependency '$1'."; }

say()  { printf "\n>>> %s\n" "$*"; }

### ───────────────────────────
### base packages
### ───────────────────────────
say "Installing base packages..."
sudo apt-get update -y
sudo apt-get install -y ca-certificates curl gnupg lsb-release jq git iproute2 arping iperf3

### ───────────────────────────
### Docker + Containerlab
### (official quick-setup paths for fast provisioning)
### ───────────────────────────
#### This approach didn't work, trying the one below. 
# if ! command -v docker >/dev/null 2>&1; then
#   say "Installing Docker via convenience script..."
#   curl -fsSL https://get.docker.com | sh   # quick provisioning path
#   sudo usermod -aG docker "$USER" || true
# fi

sudo apt-get install -y ca-certificates curl
sudo install -m 0755 -d /etc/apt/keyrings
sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg \
  -o /etc/apt/keyrings/docker.asc
sudo chmod a+r /etc/apt/keyrings/docker.asc
source /etc/os-release
echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] \
https://download.docker.com/linux/ubuntu $VERSION_CODENAME stable" | \
sudo tee /etc/apt/sources.list.d/docker.list >/dev/null
sudo apt-get update
sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
sudo usermod -aG docker "$USER"
newgrp docker <<<''
docker --version

if ! command -v containerlab >/dev/null 2>&1; then
  say "Installing Containerlab..."
  # all-in-one setup installs docker prereqs if needed on Debian/RHEL-like
  curl -sL https://containerlab.dev/setup | sudo -E bash -s "all"
fi

# make sure current shell can use docker group if newly added
if ! groups | grep -q '\bdocker\b'; then
  say "You were added to 'docker' group. Re-login or run: newgrp docker"
fi

### ───────────────────────────
### Repo: try VirtualBox shared folder first, else git clone
### ───────────────────────────
mkdir -p "$LAB_MOUNT"
if [ -e /sbin/mount.vboxsf ] || [ -e /usr/sbin/mount.vboxsf ]; then
  # Guest Additions likely present; try to mount named share
  say "Attempting to mount VirtualBox shared folder '$VB_SHARE_NAME' at '$LAB_MOUNT'..."
  sudo apt-get install -y virtualbox-guest-utils || true
  sudo usermod -aG vboxsf "$USER" || true   # access shared folder
  # try mount; if it fails, we will fallback to git
  if sudo mount -t vboxsf -o uid="$UID",gid="$(id -g)" "$VB_SHARE_NAME" "$LAB_MOUNT" 2>/dev/null; then
    say "Mounted VirtualBox share '$VB_SHARE_NAME' at '$LAB_MOUNT'."
  else
    say "Shared folder mount failed. Falling back to git clone."
    rm -rf "$LAB_MOUNT/.git" 2>/dev/null || true
    if [ ! -d "$LAB_MOUNT/.git" ]; then
      git clone --branch "$REPO_BRANCH" "$REPO_URL" "$LAB_MOUNT"
    fi
  fi
else
  say "VirtualBox Guest Additions/driver not detected. Cloning repo instead."
  if [ ! -d "$LAB_MOUNT/.git" ]; then
    git clone --branch "$REPO_BRANCH" "$REPO_URL" "$LAB_MOUNT"
  fi
fi

[ -f "$LAB_MOUNT/$LAB_FILE" ] || err "Lab file not found: $LAB_MOUNT/$LAB_FILE"

### ───────────────────────────
### Import cEOS image (optional)
### ───────────────────────────
if [ -n "$CEOS_TARBALL" ]; then
  say "Importing cEOS image from '$CEOS_TARBALL' as '$CEOS_TAG'..."
  if ! docker image inspect "$CEOS_TAG" >/dev/null 2>&1; then
    sudo docker import "$CEOS_TARBALL" "$CEOS_TAG"
  else
    say "Docker image '$CEOS_TAG' already present; skipping import."
  fi
  # Arch sanity (best effort)
  IMG_ARCH="$(sudo docker inspect "$CEOS_TAG" --format '{{.Architecture}}' 2>/dev/null || true)"
  HOST_ARCH="$(uname -m)"
  say "Image arch: ${IMG_ARCH:-unknown} | Host arch: $HOST_ARCH"
fi

### ───────────────────────────
### Keep clab run-artifacts out of your repo mount
### ───────────────────────────
mkdir -p "$HOME/.clab-runs"
if ! grep -q "CLAB_LABDIR_BASE" "$HOME/.bashrc"; then
  echo 'export CLAB_LABDIR_BASE=$HOME/.clab-runs' >> "$HOME/.bashrc"
fi
export CLAB_LABDIR_BASE="$HOME/.clab-runs"

### ───────────────────────────
### Show versions
### ───────────────────────────
say "Versions:"
docker --version || true
containerlab version || true
echo
say "Lab root at: $LAB_MOUNT"
ls -la "$LAB_MOUNT" | sed -n '1,80p'

### ───────────────────────────
### Deploy (optional)
### ───────────────────────────
if [ "${AUTO_DEPLOY}" = "1" ]; then
  say "Deploying lab: $LAB_MOUNT/$LAB_FILE"
  pushd "$LAB_MOUNT" >/dev/null
  sudo -E containerlab destroy -t "$LAB_FILE" || true
  sudo -E containerlab deploy  -t "$LAB_FILE" --reconfigure
  echo
  say "Lab status:"
  containerlab inspect -t "$LAB_FILE" | sed -n '1,120p' || true
  popd >/dev/null
else
  cat <<EOF

>>> Skipping auto-deploy (AUTO_DEPLOY=0).
To deploy manually:
  cd "$LAB_MOUNT"
  export CLAB_LABDIR_BASE=\$HOME/.clab-runs
  sudo -E containerlab deploy -t "$LAB_FILE" --reconfigure

EOF
fi

say "Done."
